<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fulfillment Air Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' } } } }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .light body { background-color: #f8fafc; color: #0f172a; }
        .dark body { background-color: #0f172a; color: #f8fafc; }
        .panel { transition: all 0.3s ease; }
        .light .panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .dark .panel { background: #1e293b; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); }
        
        /* Gold Gradient for Top Achiever */
        .gold-card { background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); color: #5c4d00; }
        .dark .gold-card { background: linear-gradient(135deg, #B8860B 0%, #8B6508 100%); color: #fff; }
    </style>
</head>
<body>

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-900 text-white hidden md:flex flex-col flex-shrink-0 z-20">
            <div class="p-6 border-b border-slate-800 flex items-center">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center mr-3 font-bold text-sm">FA</div>
                <div class="leading-tight">
                    <span class="text-lg font-bold tracking-wide block">NEXUS</span>
                    <span class="text-xs text-blue-400 font-medium">Fulfillment Air</span>
                </div>
            </div>
            <nav class="flex-1 px-4 py-6">
                <button onclick="showMainView()" class="w-full flex items-center px-4 py-3 bg-blue-600 rounded text-white mb-2 shadow-lg shadow-blue-900/50 hover:bg-blue-500 transition">
                    <i class="fas fa-chart-pie w-6"></i> Dashboard
                </button>
            </nav>
            <div class="p-4 border-t border-slate-800">
                <button onclick="toggleTheme()" class="flex items-center text-slate-400 hover:text-white w-full transition">
                    <i class="fas fa-moon w-6" id="theme-icon"></i> <span id="theme-text">Dark Mode</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-y-auto relative scroll-smooth">
            <header class="sticky top-0 z-30 px-8 py-4 flex flex-col md:flex-row justify-between items-center bg-white/90 dark:bg-slate-900/90 backdrop-blur border-b border-gray-200 dark:border-slate-700">
                <div class="mb-4 md:mb-0">
                    <h1 class="text-2xl font-extrabold tracking-tight" id="page-title">Fulfillment Air <span class="text-blue-600">Performance</span></h1>
                    <p class="text-sm opacity-60 font-medium">Sorted by Target Achievement (High to Low)</p>
                </div>
                
                <div class="flex items-center gap-4">
                    <!-- Search Bar -->
                    <div class="relative group">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400 group-focus-within:text-blue-500 transition"></i>
                        <input type="text" id="search-input" onkeyup="renderDashboard()" placeholder="Search agent..." 
                            class="pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-gray-50 dark:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 w-64 transition shadow-sm text-sm">
                    </div>

                    <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg transition hover:bg-blue-700 shadow-md flex items-center text-sm font-bold">
                        <i class="fas fa-sync-alt mr-2"></i> Refresh
                    </button>
                </div>
            </header>

            <div class="p-6 max-w-[1920px] mx-auto w-full space-y-8">
                
                <!-- Loading Area -->
                <div id="status-area" class="text-center py-20">
                    <i class="fas fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
                    <p class="text-lg font-medium animate-pulse">Syncing Fulfillment Data...</p>
                </div>

                <!-- VIEW 1: DASHBOARD -->
                <div id="view-dashboard" class="hidden space-y-8">
                    
                    <!-- TOP ACHIEVER -->
                    <div id="top-achiever-container" class="hidden animate-fade-in-up">
                        <div class="gold-card rounded-xl p-6 shadow-xl flex justify-between items-center relative overflow-hidden border border-yellow-400/30">
                            <div class="z-10">
                                <div class="text-xs font-bold uppercase tracking-widest opacity-70 mb-1">Top Performer</div>
                                <h2 id="top-name" class="text-3xl font-black mb-1 tracking-tight">Agent Name</h2>
                                <p id="top-tl" class="text-sm font-semibold opacity-90"><i class="fas fa-user-tie mr-1"></i> <span id="top-tl-text">Team Leader</span></p>
                            </div>
                            <div class="z-10 text-right">
                                <div class="text-5xl font-black tracking-tighter" id="top-score">0%</div>
                                <div class="text-xs font-bold uppercase mt-1 opacity-80">Target Achievement</div>
                            </div>
                            <i class="fas fa-trophy absolute -bottom-4 -right-4 text-9xl opacity-10 transform -rotate-12 mix-blend-overlay"></i>
                        </div>
                    </div>

                    <!-- Team Overview -->
                    <div id="team-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5"></div>

                    <!-- Agent Table -->
                    <div class="panel rounded-xl overflow-hidden">
                        <div class="p-4 border-b dark:border-slate-700 bg-gray-50/50 dark:bg-slate-800/50 flex justify-between items-center">
                            <h3 class="font-bold text-lg">Agent Performance Ranking</h3>
                            <span class="text-xs font-mono opacity-50 bg-gray-200 dark:bg-slate-700 px-2 py-1 rounded">SORT: NEW %</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="opacity-70 text-xs uppercase font-bold border-b dark:border-slate-700 border-gray-200 bg-gray-50 dark:bg-slate-800">
                                        <th class="p-4 w-12 text-center">#</th>
                                        <th class="p-4">Agent Name</th>
                                        <th class="p-4">TL</th>
                                        <th class="p-4 text-center">Needed 130%</th>
                                        <th class="p-4 text-center">New %</th>
                                        <th class="p-4 text-center">New KPIs %</th>
                                        <th class="p-4 text-right">Details</th>
                                    </tr>
                                </thead>
                                <tbody id="agent-list" class="divide-y dark:divide-slate-700 divide-gray-100 text-sm font-medium"></tbody>
                            </table>
                        </div>
                        <div id="no-results" class="hidden p-8 text-center opacity-60">
                            No agents found matching your search.
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: AGENT DETAIL -->
                <div id="view-detail" class="hidden animate-fade-in">
                    <button onclick="showMainView()" class="mb-4 text-sm font-bold text-blue-500 flex items-center hover:underline group">
                        <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition"></i> Back to Dashboard
                    </button>

                    <div class="panel rounded-2xl p-8 mb-6 border-l-8 border-blue-500 relative overflow-hidden">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center z-10 relative">
                            <div>
                                <h1 id="detail-name" class="text-3xl font-extrabold tracking-tight">Agent Name</h1>
                                <p class="text-lg opacity-60 mt-1 flex items-center"><i class="fas fa-user-circle mr-2"></i> <span id="detail-tl">Team Leader</span></p>
                            </div>
                            <div class="mt-4 md:mt-0 text-right bg-blue-50 dark:bg-slate-800 px-6 py-3 rounded-xl">
                                <div class="text-xs opacity-60 uppercase font-bold tracking-wider">Achievement</div>
                                <div id="detail-main-percent" class="text-4xl font-black text-blue-600 dark:text-blue-400">0%</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <!-- Col 1 -->
                        <div class="panel p-6 rounded-xl">
                            <h3 class="font-bold border-b pb-3 mb-4 opacity-80 flex items-center text-blue-500"><i class="fas fa-tachometer-alt mr-2"></i> Core Performance</h3>
                            <div class="space-y-4 text-sm">
                                <div class="flex justify-between"><span>Total Cases</span> <span id="d-total" class="font-bold text-base">0</span></div>
                                <div class="flex justify-between"><span>Achieved Points</span> <span id="d-points" class="font-bold text-base">0</span></div>
                                <div class="flex justify-between"><span>Needed 130%</span> <span id="d-needed" class="font-bold text-base">0</span></div>
                                <div class="flex justify-between"><span>Support</span> <span id="d-support" class="font-bold text-base">0</span></div>
                            </div>
                        </div>
                        <!-- Col 2 -->
                        <div class="panel p-6 rounded-xl">
                            <h3 class="font-bold border-b pb-3 mb-4 opacity-80 flex items-center text-purple-500"><i class="fas fa-chart-line mr-2"></i> Productivity & SLA</h3>
                            <div class="space-y-5">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">In Meeting ( >20% )</span>
                                    <span id="d-meeting" class="px-3 py-1 rounded font-bold text-sm">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">Off Board</span>
                                    <span id="d-offboard" class="font-mono font-bold text-sm">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">SLA ( >10% )</span>
                                    <span id="d-sla" class="px-3 py-1 rounded font-bold text-sm">-</span>
                                </div>
                            </div>
                        </div>
                        <!-- Col 3 -->
                        <div class="panel p-6 rounded-xl">
                            <h3 class="font-bold border-b pb-3 mb-4 opacity-80 flex items-center text-emerald-500"><i class="fas fa-check-circle mr-2"></i> Compliance</h3>
                            <div class="space-y-5">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">Quality Score</span>
                                    <span id="d-quality" class="text-xl font-black">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">Lateness (Max 22m)</span>
                                    <span id="d-lateness" class="px-3 py-1 rounded font-bold text-sm">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">SF Lateness (Max 60m)</span>
                                    <span id="d-sf" class="px-3 py-1 rounded font-bold text-sm">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Raw Data Table -->
                    <div class="panel rounded-xl overflow-hidden">
                        <div class="p-4 bg-gray-50 dark:bg-slate-800 font-bold border-b dark:border-slate-700 flex items-center">
                            <i class="fas fa-list-ul mr-2 text-gray-400"></i> Detailed Breakdown
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-center">
                                <thead class="bg-gray-100 dark:bg-slate-900 text-xs uppercase text-gray-500">
                                    <tr>
                                        <th class="p-3">1G SCH</th>
                                        <th class="p-3">Auto</th>
                                        <th class="p-3">Check In</th>
                                        <th class="p-3">DMC</th>
                                        <th class="p-3">Expired</th>
                                        <th class="p-3">Failed</th>
                                        <th class="p-3">Manual</th>
                                        <th class="p-3">Refunds</th>
                                        <th class="p-3">Reissue</th>
                                        <th class="p-3">Avg/Day</th>
                                    </tr>
                                </thead>
                                <tbody class="font-mono text-base font-semibold">
                                    <tr>
                                        <td class="p-4" id="r-1g">0</td>
                                        <td class="p-4" id="r-auto">0</td>
                                        <td class="p-4" id="r-checkin">0</td>
                                        <td class="p-4" id="r-dmc">0</td>
                                        <td class="p-4" id="r-expired">0</td>
                                        <td class="p-4" id="r-failed">0</td>
                                        <td class="p-4" id="r-manual">0</td>
                                        <td class="p-4" id="r-refund">0</td>
                                        <td class="p-4" id="r-reissue">0</td>
                                        <td class="p-4 font-black text-blue-600" id="r-avg">0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        // ==========================================
        // 1. PASTE YOUR 7 CSV LINKS HERE
        // ==========================================
        const URLS = {
         main:       'https://docs.google.com/spreadsheets/d/e/2PACX-1vRXU_uKONZDDeNjOE_P579aAJvJRLXq6K8qnB-yYvL41LWBKfsW7hIc_e5xC9t9mZZDIbhHl-1RxtKN/pub?gid=870255286&single=true&output=csv',      // The Sheet with "Agent Name", "TL", "New %"
            prod:       'https://docs.google.com/spreadsheets/d/e/2PACX-1vRXU_uKONZDDeNjOE_P579aAJvJRLXq6K8qnB-yYvL41LWBKfsW7hIc_e5xC9t9mZZDIbhHl-1RxtKN/pub?gid=1481469985&single=true&output=csv',
            sla:        'https://docs.google.com/spreadsheets/d/e/2PACX-1vRXU_uKONZDDeNjOE_P579aAJvJRLXq6K8qnB-yYvL41LWBKfsW7hIc_e5xC9t9mZZDIbhHl-1RxtKN/pub?gid=263302978&single=true&output=csv',
            quality:    'https://docs.google.com/spreadsheets/d/e/2PACX-1vRXU_uKONZDDeNjOE_P579aAJvJRLXq6K8qnB-yYvL41LWBKfsW7hIc_e5xC9t9mZZDIbhHl-1RxtKN/pub?gid=1687296005&single=true&output=csv',
            lateness:   'https://docs.google.com/spreadsheets/d/e/2PACX-1vRXU_uKONZDDeNjOE_P579aAJvJRLXq6K8qnB-yYvL41LWBKfsW7hIc_e5xC9t9mZZDIbhHl-1RxtKN/pub?gid=75298798&single=true&output=csv',
            sf:         'https://docs.google.com/spreadsheets/d/e/2PACX-1vRXU_uKONZDDeNjOE_P579aAJvJRLXq6K8qnB-yYvL41LWBKfsW7hIc_e5xC9t9mZZDIbhHl-1RxtKN/pub?gid=2091376254&single=true&output=csv',
            mapping:    'https://docs.google.com/spreadsheets/d/e/2PACX-1vRXU_uKONZDDeNjOE_P579aAJvJRLXq6K8qnB-yYvL41LWBKfsW7hIc_e5xC9t9mZZDIbhHl-1RxtKN/pub?gid=255056990&single=true&output=csv'        // The Sheet with "Name" and "Email Address"
        };
        // ==========================================

        let GLOBAL_DATA = [];

        // Dark Mode Logic
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            html.classList.toggle('light');
            document.getElementById('theme-text').innerText = isDark ? "Light Mode" : "Dark Mode";
            document.getElementById('theme-icon').className = isDark ? "fas fa-sun w-6" : "fas fa-moon w-6";
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        if(localStorage.getItem('theme') === 'dark') toggleTheme();

        // Data Helper
        function cleanNum(str) {
            if(!str) return 0;
            return parseFloat(str.toString().replace(/,/g, '').replace(/%/g, '')) || 0;
        }

        // Fetch Logic
        async function fetchData() {
            const statusArea = document.getElementById('status-area');
            
            if(URLS.main.includes('PASTE_')) {
                statusArea.innerHTML = `<div class="text-red-500 font-bold text-xl">⚠️ Configuration Error</div><div class="mt-2">Please edit the code and paste your Google Sheet CSV links.</div>`;
                return;
            }

            try {
                const results = await Promise.all([
                    fetchCSV(URLS.main), fetchCSV(URLS.prod), fetchCSV(URLS.sla),
                    fetchCSV(URLS.quality), fetchCSV(URLS.lateness), fetchCSV(URLS.sf),
                    fetchCSV(URLS.mapping)
                ]);

                processData(...results);
                
                statusArea.classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');

            } catch (err) {
                console.error(err);
                statusArea.innerHTML = `<div class="text-red-500 font-bold text-xl">❌ Sync Failed</div><div class="text-gray-500 mt-2 text-sm">${err.message}</div>`;
            }
        }

        function fetchCSV(url) {
            return new Promise((resolve) => {
                Papa.parse(url, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: (res) => resolve(res.data),
                    error: () => resolve([]) 
                });
            });
        }

        function processData(main, prod, sla, qual, late, sf, mapData) {
            const map = {};
            const emailToName = {};

            // 1. Build Email Map
            mapData.forEach(row => {
                const name = row['Name']?.trim();
                const email = row['Email Address']?.trim().toLowerCase();
                if(name && email) emailToName[email] = name;
            });

            // Helper to resolve name
            function resolveName(row, nameCol, emailCol) {
                let n = row[nameCol]?.trim();
                if(n && map[n]) return n;
                let e = row[emailCol]?.trim().toLowerCase();
                if(e && emailToName[e] && map[emailToName[e]]) return emailToName[e];
                return null;
            }

            // 2. Main Data
            main.forEach(row => {
                const name = row['Agent Name']?.trim();
                if(!name) return;

                map[name] = {
                    ...row,
                    name: name,
                    tl: row['TL'] || 'Unassigned',
                    percentRaw: cleanNum(row['New %']),
                    percentStr: row['New %'] || '0%',
                    kpiStr: row['New KPIs %'] || '0%',
                    needed: row['Needed Points 130%'] || '0',
                    inMeeting: 0, offBoard: 0, sla: 0, quality: 0, lateness: 0, sfLateness: 0
                };
            });

            // 3. Productivity
            prod.forEach(row => {
                let targetName = null;
                const email = row['Email']?.trim().toLowerCase();
                if(email && emailToName[email]) targetName = emailToName[email];

                if(targetName && map[targetName]) {
                    const meetingMins = cleanNum(row['In_a_Meeting']);
                    const offBoardMins = cleanNum(row['Off_Board']);
                    const totalMins = cleanNum(row['Total']);

                    if(totalMins > 0) {
                        map[targetName].inMeeting = ((meetingMins / totalMins) * 100).toFixed(1);
                        map[targetName].offBoard = ((offBoardMins / totalMins) * 100).toFixed(1);
                    }
                }
            });

            // 4. Other Sheets
            sla.forEach(row => {
                const n = resolveName(row, 'Case History Owner', 'dummy');
                if(n) map[n].sla = cleanNum(row['Percentage']);
            });

            qual.forEach(row => {
                const n = resolveName(row, 'Name of the Agent', 'dummy');
                if(n) map[n].quality = cleanNum(row['Percentage']);
            });

            late.forEach(row => {
                const n = resolveName(row, 'Name', 'dummy');
                if(n) map[n].lateness = cleanNum(row['SUM of Lateness']);
            });

            sf.forEach(row => {
                const n = resolveName(row, 'Agent Name', 'dummy');
                if(n) map[n].sfLateness = cleanNum(row['Lateness (Max 60 Min)']);
            });

            // Sort High to Low
            GLOBAL_DATA = Object.values(map).sort((a,b) => b.percentRaw - a.percentRaw);

            renderDashboard();
        }

        function renderDashboard() {
            const list = document.getElementById('agent-list');
            const teamGrid = document.getElementById('team-grid');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const noResults = document.getElementById('no-results');
            
            let rows = '';
            const teams = {};
            let filteredCount = 0;

            // Filter Data for Search
            const filteredData = GLOBAL_DATA.filter(agent => agent.name.toLowerCase().includes(searchTerm));

            // 1. TOP ACHIEVER Logic
            if(GLOBAL_DATA.length > 0 && searchTerm === '') {
                const top = GLOBAL_DATA[0];
                document.getElementById('top-achiever-container').classList.remove('hidden');
                document.getElementById('top-name').innerText = top.name;
                document.getElementById('top-tl-text').innerText = top.tl;
                document.getElementById('top-score').innerText = top.percentStr;
            } else {
                // Hide top achiever if searching (to reduce clutter)
                document.getElementById('top-achiever-container').classList.add('hidden');
            }

            // Calculate Team Stats from FULL Data (to keep averages correct)
            GLOBAL_DATA.forEach(agent => {
                 if(!teams[agent.tl]) teams[agent.tl] = { sum:0, count:0 };
                 teams[agent.tl].sum += agent.percentRaw;
                 teams[agent.tl].count++;
            });

            // Render Table Rows (Filtered)
            filteredData.forEach((agent, i) => {
                filteredCount++;
                const achClass = agent.percentRaw >= 100 ? 'text-green-600 dark:text-green-400 font-bold' : 'text-slate-500 dark:text-slate-400';
                rows += `
                <tr class="hover-row border-b dark:border-slate-700 cursor-pointer transition" onclick="showAgentDetail('${agent.name.replace(/'/g, "\\'")}')">
                    <td class="p-4 text-center text-xs opacity-50 font-mono">${i+1}</td>
                    <td class="p-4 font-semibold text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition">${agent.name}</td>
                    <td class="p-4 text-xs opacity-70">${agent.tl}</td>
                    <td class="p-4 text-center font-mono">${agent.needed}</td>
                    <td class="p-4 text-center text-lg ${achClass}">${agent.percentStr}</td>
                    <td class="p-4 text-center opacity-80">${agent.kpiStr}</td>
                    <td class="p-4 text-right">
                        <button class="bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 hover:bg-blue-50 dark:hover:bg-slate-600 text-blue-600 dark:text-blue-300 px-3 py-1 rounded-lg text-xs font-bold transition shadow-sm">
                            View <i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </td>
                </tr>`;
            });

            list.innerHTML = rows;
            
            if(filteredCount === 0) {
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
            }

            // 3. Render Teams (Sorted by Performance: High to Low)
            let teamHtml = '';
            
            const sortedTeams = Object.keys(teams)
                .filter(tl => tl.toLowerCase() !== 'unassigned') // Remove Unassigned
                .sort((a, b) => {
                    const avgA = teams[a].sum / teams[a].count;
                    const avgB = teams[b].sum / teams[b].count;
                    return avgB - avgA; // Sort Highest Average to Lowest
                });

            sortedTeams.forEach(tl => {
                const data = teams[tl];
                const avg = (data.sum / data.count).toFixed(1);
                
                let borderClass = 'border-blue-500';
                if(avg >= 100) borderClass = 'border-green-500';
                if(avg < 80) borderClass = 'border-orange-500';

                teamHtml += `
                <div class="panel p-5 rounded-xl border-l-4 ${borderClass} hover:-translate-y-1 transition duration-300">
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-bold text-lg truncate pr-2" title="${tl}">${tl}</div>
                        <span class="text-xs font-mono bg-gray-100 dark:bg-slate-700 px-2 py-1 rounded">${data.count}</span>
                    </div>
                    <div class="flex items-baseline">
                        <div class="text-3xl font-black tracking-tight">${avg}%</div>
                        <div class="text-xs opacity-50 ml-2 uppercase font-bold">Avg Achv.</div>
                    </div>
                </div>`;
            });
            teamGrid.innerHTML = teamHtml;
        }

        function showAgentDetail(name) {
            const agent = GLOBAL_DATA.find(a => a.name === name);
            if(!agent) return;

            document.getElementById('detail-name').innerText = agent.name;
            document.getElementById('detail-tl').innerText = agent.tl;
            document.getElementById('detail-main-percent').innerText = agent.percentStr;

            // Core
            document.getElementById('d-total').innerText = agent['Total'] || 0;
            document.getElementById('d-points').innerText = agent['Achieved Points'] || 0;
            document.getElementById('d-needed').innerText = agent['Needed Points 130%'] || 0;
            document.getElementById('d-support').innerText = agent['Support'] || 0;

            // Prod / SLA
            setMetric('d-meeting', agent.inMeeting + '%', parseFloat(agent.inMeeting) > 20, false);
            document.getElementById('d-offboard').innerText = agent.offBoard + '%';
            setMetric('d-sla', agent.sla + '%', parseFloat(agent.sla) > 10, false);

            // Compliance
            const qEl = document.getElementById('d-quality');
            qEl.innerText = agent.quality + '%';
            qEl.className = `text-xl font-black ${agent.quality >= 90 ? 'text-green-500' : 'text-orange-500'}`;

            setMetric('d-lateness', agent.lateness + 'm', agent.lateness > 22, true);
            setMetric('d-sf', agent.sfLateness + 'm', agent.sfLateness > 60, true);

            // Raw Data
            const rawMap = {'1G SCH': 'r-1g', 'Auto': 'r-auto', 'Check In': 'r-checkin', 'DMC': 'r-dmc', 'Expired Payment': 'r-expired', 'Failed': 'r-failed', 'Manual': 'r-manual', 'Reissue /Refunds': 'r-refund', 'Refund Others': 'r-reissue', 'AVG Cases Per Day': 'r-avg'};
            
            for (const [key, id] of Object.entries(rawMap)) {
                document.getElementById(id).innerText = agent[key] || 0;
            }

            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-detail').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function showMainView() {
            document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('view-detail').classList.add('hidden');
            document.getElementById('search-input').value = ''; // Clear search on back
            renderDashboard(); // Reset table
            window.scrollTo(0,0);
        }

        function setMetric(id, value, isDanger, isGoodGreen) {
            const el = document.getElementById(id);
            el.innerText = value;
            if(isDanger) {
                el.className = 'px-3 py-1 rounded font-bold text-sm bg-red-100 text-red-600 border border-red-200 dark:bg-red-900/30 dark:border-red-800 dark:text-red-400';
            } else {
                el.className = isGoodGreen 
                    ? 'px-3 py-1 rounded font-bold text-sm bg-green-100 text-green-600 border border-green-200 dark:bg-green-900/30 dark:border-green-800 dark:text-green-400' 
                    : 'font-bold text-slate-600 dark:text-slate-300 text-sm';
            }
        }

        // Init
        fetchData();
    </script>
</body>
</html>